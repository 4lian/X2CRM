/*********************************************************************************
 * The X2CRM by X2Engine Inc. is free software. It is released under the terms of 
 * the following BSD License.
 * http://www.opensource.org/licenses/BSD-3-Clause
 * 
 * X2Engine Inc.
 * P.O. Box 66752
 * Scotts Valley, California 95067 USA
 * 
 * Company website: http://www.x2engine.com 
 * Community and support website: http://www.x2community.com 
 * 
 * Copyright (C) 2011-2012 by X2Engine Inc. www.X2Engine.com
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without modification, 
 * are permitted provided that the following conditions are met:
 * 
 * - Redistributions of source code must retain the above copyright notice, this 
 *   list of conditions and the following disclaimer.
 * - Redistributions in binary form must reproduce the above copyright notice, this 
 *   list of conditions and the following disclaimer in the documentation and/or 
 *   other materials provided with the distribution.
 * - Neither the name of X2Engine or X2CRM nor the names of its contributors may be 
 *   used to endorse or promote products derived from this software without 
 *   specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
 * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
 * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 ********************************************************************************/

var formEditorVersion="1.2";window.selectedFormItems=$([]);window.layoutChanged=false;function toggleFormSection(b){if($(b).hasClass("showSection")){$(b).find(".tableWrapper").slideToggle(400,function(){$(this).parent(".formSection").toggleClass("showSection")})}else{$(b).toggleClass("showSection").find(".tableWrapper").slideToggle(400)}}$(function(){$("#addRow").click(function(){addFormSection()});$("#addCollapsibleRow").click(function(){addFormSection("collapsible")});$("#setTabOrder").click(function(){$(this).toggleClass("clicked");$("#formEditor").toggleClass("tabOrderMode");$("#formEditor .formTabOrder").each(function(b,c){$(c).html((b+1))})});$(document).delegate(".formSectionDelete","click",function(){deleteFormSection($(this))});$("#borderToggleButton").click(function(){deselectAll();$("#formEditor").toggleClass("editMode");$("#borderToggleButton").toggleClass("clicked");if($("#borderToggleButton").hasClass("clicked")){$(".formSortable").sortable("option","disabled",true)}else{$(".formSortable").sortable("option","disabled",false)}});$("#formEditorForm").submit(function(){if($("#modelList").val()!=""&&$("#modelList").val()!=""){$("#layoutHiddenField").val(generateFormJson())}else{return false}});$("div.x2-layout").delegate(".formSectionShow, .formSectionHide","click",function(){toggleFormSection($(this).closest(".formSection"));saveFormSections()});$(document).delegate(".formSectionAddCol","click",function(){addColumn($(this).closest(".formSection"))});$(document).delegate(".formSectionDelCol","click",function(){deleteColumn($(this).closest(".formSection"))});$(document).delegate(".formSectionSetName","click",function(){setSectionName($(this).closest(".formSection"))});$(document).delegate("#formEditor .formItem","click",function(b){if(!$("#borderToggleButton").hasClass("clicked")){if(!b.shiftKey){deselectAll()}if(window.selectedFormItems.is(this)){$(this).removeClass("selected");window.selectedFormItems=window.selectedFormItems.not(this);if(window.selectedFormItems.length==0){$(".formItemOptions").fadeOut(400)}}else{$(this).addClass("selected");window.selectedFormItems=window.selectedFormItems.add(this);updateFormItemOptions();$(".formItemOptions").fadeIn(400)}}});$(document).click(function(c){var b=$(c.target).add($(c.target).parents());if(!c.shiftKey&&!b.is("#formEditor .formItem, #formEditorControls")){deselectAll()}});$(document).keydown(function(b){if(b.which==46&&$("input:focus, textarea:focus").length==0){window.selectedFormItems.removeClass("selected").appendTo("#editorFieldList");resetFormItem(window.selectedFormItems);sortFieldList();deselectAll()}});$("#labelType").change(function(b){setLabelType(window.selectedFormItems,$(this).val())});$("#readOnly").change(function(b){setReadOnly(window.selectedFormItems,$(this).val())});$("#formEditor").sortable({tolerance:"intersect",items:".formSection",placeholder:"formSectionPlaceholder",handle:".formSectionHeader",opacity:0.5,axis:"y",distance:10,change:function(){window.layoutChanged=true}});$("#editorFieldList").sortable({connectWith:".formSortable",tolerance:"pointer",placeholder:"formItemPlaceholder",remove:function(b,c){$(b.target).closest(".formItem").data({labelType:"top",readOnly:0}).find(".formInputBox").resizable({grid:[5,10],handles:($(b.target).parent().find("textarea").length>0)?"e,se,s":"e",stop:function(){window.layoutChanged=true}}).closest(".formInput").addClass("topLabel");window.layoutChanged=true},receive:function(b,c){resetFormItem($(c.item));sortFieldList();window.layoutChanged=true},update:function(b,c){sortFieldList()}});$("div.x2-layout").delegate("div.x2-layout .inlineLabel input:text, div.x2-layout .inlineLabel textarea","focus",function(){formFieldFocus(this)});$("div.x2-layout").delegate("div.x2-layout .inlineLabel input:text, div.x2-layout .inlineLabel textarea","blur",function(){formFieldBlur(this)})});function addFormSection(e,d,f){if(typeof e=="undefined"){e="default"}if(typeof d!="number"){d=1}if(typeof f=="undefined"){f=""}var c='<div class="formSectionHeader">';c+='<a href="javascript:void(0)" class="formSectionDelCol">&ndash;Col</a>';c+='<a href="javascript:void(0)" class="formSectionAddCol">+Col</a>';c+='<a href="javascript:void(0)" class="formSectionSetName">Rename</a>';c+='<a href="javascript:void(0)" class="formSectionDelete">[ x ]</a>';if(e=="collapsible"){c+='<a href="javascript:void(0)" class="formSectionShow">[+]</a><a href="javascript:void(0)" class="formSectionHide">[&ndash;]</a>'}c+='<span class="sectionTitle">'+f+"</span>";c+='</div><div class="tableWrapper"><table><tr class="formSectionRow">';for(a=0;a<d;a++){c+='<td><div class="formSortable"></div></td>'}c+="</tr></table></div></div>";$(document.createElement("div")).addClass("formSection showSection"+((e=="collapsible")?" collapsible":"")).appendTo("#formEditor").html(c).find(".formSortable").sortable({connectWith:".formSortable",items:".formItem",tolerance:"pointer",placeholder:"formItemPlaceholder"});var b=$("#formEditor").find(".formSection").last().find("table");setupColResizing(b);window.layoutChanged=true}function deleteFormSection(c){var b=c.closest(".formSection").find(".formItem");resetFormItem(b);window.selectedFormItems=window.selectedFormItems.not(b);b.removeClass("selected").appendTo("#editorFieldList");sortFieldList();c.closest(".formSection").fadeOut(300,function(){$(this).remove()});window.layoutChanged=true}function setSectionName(c){var b=prompt("Please enter a name for this section.");if(b!=null){c.find(".sectionTitle").html(b)}}function addColumn(c){var b=c.find("table");b.find("tr.formSectionRow").each(function(g,o){var e=$(o).find("td");$('<td><div class="formSortable"></div></td>').appendTo($(o)).find(".formSortable").sortable({connectWith:".formSortable",tolerance:"pointer",items:".formItem",placeholder:"formItemPlaceholder"});if(g==0){var n=$(o).width();var d=n/e.length;$(o).find("td:last").width(d);var m=n/$(o).width();var l=0,h=0,f=0;$(o).find("td").each(function(q,p){l+=$(p).width();f=Math.round((l*m)-h);$(p).width(f-1);h+=f})}});setupColResizing(b);window.layoutChanged=true}function deleteColumn(c){var b=c.find("table");b.find("tr.formSectionRow").each(function(f,p){var d=$(p).find("td");if(d.length<2){return}if(f==0){var n=$(p).width();var l=n/(n-d.last().width());var h=0,g=0,e=0;$(p).find("td:not(:last)").each(function(r,q){h+=$(q).width();e=Math.round((h*l)-g);$(q).width(e)+1;g+=e})}var m=$(d[d.length-1]);var o=$(d[d.length-2]);m.find(".formItem").appendTo(o.find(".formSortable"));m.remove()});setupColResizing(b);window.layoutChanged=true}function setupColResizing(b){b.colResizable({disable:true}).colResizable({liveDrag:true,draggingClass:"colResizableDragging",onResize:function(){window.layoutChanged=true}})}function setLabelType(b,c){if(typeof c!="undefined"&&c!=""){b.data("labelType",c)}switch(c){case"left":b.each(function(d,e){$(e).removeClass("inlineLabel noLabel topLabel").addClass("leftLabel");$(e).find("input,textarea").attr("value","").val("").css("color","#000")});break;case"inline":b.each(function(e,f){$(f).removeClass("topLabel leftLabel").addClass("inlineLabel");var d=$(f).find("label").html();$(f).find("input,textarea").attr("value",d).val(d).css("color","#aaa")});break;case"none":b.each(function(d,e){$(e).removeClass("inlineLabel topLabel leftLabel").addClass("noLabel");$(e).find("input,textarea").attr("value","").val("").css("color","#000")});break;case"top":default:b.each(function(d,e){$(e).removeClass("inlineLabel noLabel leftLabel").addClass("topLabel");$(e).find("input,textarea").attr("value","").val("").css("color","#000")})}window.layoutChanged=true}function setReadOnly(b,c){if(typeof c!="undefined"&&c!=""){b.data("readOnly",c)}switch(c){case"1":b.find("input,textarea").attr("disabled","disabled");break;case"0":default:b.find("input,textarea").removeAttr("disabled")}window.layoutChanged=true}function updateFormItemOptions(){var b="";var c="";window.selectedFormItems.each(function(d,e){if(b==""){b=$(e).data("labelType")}else{if(b!=$(e).data("labelType")){b="mixed"}}if(c==""){c=$(e).data("readOnly")}else{if(c!=$(e).data("readOnly")){c="mixed"}}});$("#labelType").val(b);$("#readOnly").val(c)}function deselectAll(){window.selectedFormItems.removeClass("selected");window.selectedFormItems=$([]);$(".formItemOptions").fadeOut(400)}function resetFormItem(b){window.selectedFormItems=window.selectedFormItems.not(b);b.removeClass("selected");b.removeClass("noLabel leftLabel").addClass("topLabel");b.find(".formInputBox").resizable("destroy").css({height:"",width:""});b.find("input, textarea").attr("value","").removeAttr("disabled").val("").css("color","#000");b.data("labelType","");b.data("readOnly","")}function sortFieldList(){var c=$("#editorFieldList");var b=c.children(".formItem").get();b.sort(function(e,d){var g=$(e).find("label").html().toLowerCase();var f=$(d).find("label").html().toLowerCase();return g.localeCompare(f)});$.each(b,function(d,e){c.append(e)})}function generateFormJson(){var b=[];$("#formEditor .formSection").each(function(d,f){var c="{";var e=[];if($(f).hasClass("collapsible")){c+='"collapsible":true,'}else{c+='"collapsible":false,'}var g=$(f).find(".sectionTitle").html();c+='"title":"'+((g=="undefined")?"":g.replace(/\\/g,"\\\\").replace(/"/g,'\\"'))+'",';$(f).find("tr").each(function(h,n){var l="{";var m=[];$(n).find("td").each(function(p,q){columnJson='{"width":'+$(q).width()+",";var o=[];$(q).find(".formItem").each(function(r,s){var t="{";t+='"name":"'+$(s).attr("id")+'",';t+='"labelType":"'+$(s).data("labelType")+'",';t+='"readOnly":"'+$(s).data("readOnly")+'",';t+='"height":"'+$(s).find(".formInputBox").height()+'",';t+='"width":"'+$(s).find(".formInputBox").width()+'",';t+='"tabindex":"'+$(s).find("input,textarea,checkbox,select").first().attr("tabindex")+'"';t+="}";o.push(t)});columnJson+='"items":['+o.join(",")+"]}";m.push(columnJson)});l='{"cols":['+m.join(",")+"]}";e.push(l)});c+='"rows":['+e.join(",")+"]}";b.push(c)});return'{"version":"'+formEditorVersion+'","sections":['+b.join(",")+"]}"}function loadFormJson(e){var f=$.parseJSON(e);for(i=0;i<f.sections.length;i++){var h=f.sections[i];var d=h.collapsible?"collapsible":"";if(h.rows.length>0){addFormSection(d,h.rows[0].cols.length,h.title);$formSection=$("#formEditor .formSection:last");for(j=0;j<h.rows[0].cols.length;j++){var c=$formSection.find("td:nth-child("+(j+1)+")");c.width(h.rows[0].cols[j].width);for(k=0;k<h.rows[0].cols[j].items.length;k++){var b=h.rows[0].cols[j].items[k];var g=$("#editorFieldList").find("#"+b.name);g.appendTo(c.find(".formSortable")).data({labelType:b.labelType,readOnly:b.readOnly}).find(".formInputBox").resizable({grid:[5,10],handles:(g.find("textarea").length>0)?"e,se,s":"e",stop:function(){window.layoutChanged=true}}).height(b.height).width(b.width).find("input,textarea,checkbox,select").attr("tabindex",b.tabindex);setReadOnly(g,b.readOnly);setLabelType(g,b.labelType)}}setupColResizing($formSection.find("table"))}}window.layoutChanged=false};